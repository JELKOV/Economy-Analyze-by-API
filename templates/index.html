<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IMF ê²½ì œ ë°ì´í„° ë¶„ì„</title>

    <!-- âœ… Bootstrap + Select2 ì¶”ê°€ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <script>
        $(document).ready(function () {
            // ğŸŒ IMF APIì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ê²½ì œ ì§€í‘œ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            function loadIndicators() {
                fetch('/list-indicators')
                    .then(response => response.json())
                    .then(data => {
                        let indicatorSelect = $("#indicator");
                        indicatorSelect.empty().append(new Option("ê²½ì œ ì§€í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”", ""));

                        $.each(data, function (key, value) {
                            indicatorSelect.append(new Option(value, key));
                        });
                    })
                    .catch(error => console.error("Error loading indicators:", error));
            }

            // ğŸŒ IMF APIì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ êµ­ê°€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            function loadCountries() {
                fetch('/list-countries')
                    .then(response => response.json())
                    .then(data => {
                        let countrySelect = $("#countries");
                        countrySelect.empty();

                        $.each(data, function (key, value) {
                            countrySelect.append(new Option(value, key));
                        });

                        // âœ… Select2 í”ŒëŸ¬ê·¸ì¸ ì ìš© (ê²€ìƒ‰ ê°€ëŠ¥)
                        countrySelect.select2({
                            placeholder: "êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš” (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)",
                            allowClear: true
                        });
                    })
                    .catch(error => console.error("Error loading countries:", error));
            }

            // ğŸŒ IMF ë°ì´í„° ìš”ì²­ ë° ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
            function fetchData() {
                let indicator = $("#indicator").val();
                let countries = $("#countries").val();
                let startYear = $("#startYear").val();
                let endYear = $("#endYear").val();

                if (!indicator) {
                    alert("ğŸ“Œ ê²½ì œ ì§€í‘œë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                    return;
                }
                if (!countries || countries.length === 0) {
                    alert("ğŸ“Œ ìµœì†Œ í•œ ê°œ ì´ìƒì˜ êµ­ê°€ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
                    return;
                }

                let years = `${startYear},${endYear}`;
                let apiUrl = `/get-data?indicator=${indicator}&countries=${countries.join(',')}&years=${years}`;
                let plotUrl = `/plot-data?indicator=${indicator}&countries=${countries.join(',')}&years=${years}`;

                // âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ í‘œì‹œ
                $("#loading").show();
                $("#gdpPlot").hide();

                fetch(apiUrl)
                    .then(response => response.json())
                    .then(data => {
                        $("#loading").hide();
                        $("#gdpPlot").show();

                        if (data.error) {
                            $("#jsonData").text("âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                            $("#gdpPlot").attr("src", "no-data.png");
                        } else {
                            $("#jsonData").text(JSON.stringify(data, null, 2));
                            $("#gdpPlot").attr("src", plotUrl);
                        }
                    })
                    .catch(error => console.error("Error fetching data:", error));
            }

            // ğŸŒ ì—°ë„ ë²”ìœ„ ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
            function updateYearLabel() {
                let startYear = $("#startYear").val();
                let endYear = $("#endYear").val();
                $("#yearLabel").text(`${startYear} ~ ${endYear}`);
            }

            // ğŸŒ ìŠ¬ë¼ì´ë” ê°’ ë³€ê²½ ì´ë²¤íŠ¸ ì—°ê²°
            $("#startYear, #endYear").on("input", function () {
                let startYear = parseInt($("#startYear").val());
                let endYear = parseInt($("#endYear").val());

                // ğŸ›  ë§Œì•½ ì‹œì‘ì—°ë„ê°€ ì¢…ë£Œì—°ë„ë³´ë‹¤ í¬ë‹¤ë©´, ì¢…ë£Œì—°ë„ë¥¼ ìë™ìœ¼ë¡œ ì¡°ì •
                if (startYear > endYear) {
                    $("#endYear").val(startYear);
                }

                updateYearLabel();
            });

            // ğŸŒ í˜ì´ì§€ ë¡œë“œ ì‹œ IMF ê²½ì œ ì§€í‘œ ë° êµ­ê°€ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
            loadIndicators();
            loadCountries();

            // âœ… "ì¡°íšŒ" ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
            $("#fetchDataBtn").click(function (e) {
                e.preventDefault();
                fetchData();
            });

            // âœ… ì´ˆê¸° ì—°ë„ ì„¤ì •
            updateYearLabel();
        });
    </script>

    <style>
        .container { max-width: 900px; }
        #loading { display: none; text-align: center; margin-top: 10px; }
        .card { box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); border-radius: 10px; }
    </style>
</head>
<body class="container mt-5">

    <h1 class="text-center mb-4">ğŸ“Š IMF ê²½ì œ ë°ì´í„° ë¶„ì„</h1>

    <!-- âœ… ê²€ìƒ‰ í¼ UI ê°œì„  -->
    <div class="card p-4">
        <form>
            <div class="mb-3">
                <label for="indicator" class="form-label">ê²½ì œ ì§€í‘œ ì„ íƒ:</label>
                <select id="indicator" class="form-control"></select>
            </div>

            <div class="mb-3">
                <label for="countries" class="form-label">êµ­ê°€ ì„ íƒ (ê²€ìƒ‰ ê°€ëŠ¥, ë‹¤ì¤‘ ì„ íƒ):</label>
                <select id="countries" class="form-control" multiple></select>
            </div>

            <!-- âœ… ì—°ë„ ë²”ìœ„ ì„¤ì • -->
            <div class="mb-3">
                <label class="form-label">ì¡°íšŒ ì—°ë„ ë²”ìœ„:</label>
                <div class="d-flex align-items-center">
                    <input type="range" id="startYear" min="1980" max="2025" value="2010" step="1" class="form-range me-3">
                    <span class="fw-bold">~</span>
                    <input type="range" id="endYear" min="1980" max="2025" value="2025" step="1" class="form-range ms-3">
                </div>
                <p id="yearLabel" class="text-center">2010 ~ 2024</p>
            </div>

            <button id="fetchDataBtn" class="btn btn-primary w-100">ğŸ“Š ë°ì´í„° ì¡°íšŒ</button>
        </form>
    </div>

    <!-- âœ… ë¡œë”© ìŠ¤í”¼ë„ˆ -->
    <div id="loading">
        <img src="{{ url_for('static', filename='loading-spinner.gif') }}" alt="Loading..." width="50">
    </div>

    <!-- ğŸ“Š ë°ì´í„° ì°¨íŠ¸ -->
    <div class="card mt-4 p-4">
        <h2>ğŸ“Š ê²½ì œ ë°ì´í„° ì°¨íŠ¸</h2>
        <img id="gdpPlot" src="" alt="ê²½ì œ ë°ì´í„° ì°¨íŠ¸" width="100%">
    </div>

    <!-- ğŸ“„ JSON ë°ì´í„° -->
    <div class="card mt-4 p-4">
        <h2>ğŸ“„ JSON ë°ì´í„°</h2>
        <pre id="jsonData" class="bg-light p-3 rounded"></pre>
    </div>

    <!-- âœ… Bootstrap JS ì¶”ê°€ -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
